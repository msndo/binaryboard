<!DOCTYPE html>
<html lang="ja" id="html">
<head>
<meta charset="utf-8">
<title>足し算</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="format-detection" content="telephone=no">
<meta name="keywords" content="">
<meta name="description" content="">
<link rel="stylesheet" type="text/css" media="screen, tv, print" href="css/style.css">
</head>

<body>
<div class="appdemoBinarySwitch">
<header class="containerTitlePage">
<h1 class="titlePage">足し算</h1>
<p class="tagline">Calculate Addition</p>
</header>

<img class="preload" src="img/switch_denki_dentou_on.png" alt="">
<img class="preload" src="img/small_star7_yellow.png" alt="">

<div class="demoAddition">
<div class="crusterSwitch valueFrom">
<div class="containerBitWithIncDec">
<div class="componentSwitchHex">
<span class="codeHex">0</span>
<ul class="seriesSwitch">
<li class="containerSwitch"></a><span class="indicationDigit">8</span><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"></a><span class="indicationDigit">4</span><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"></a><span class="indicationDigit">2</span><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"></a><span class="indicationDigit">1</span><a class="contentSwitch" href="javascript:void(0);"></a></li>
</ul>
</div>
<!-- /containerBitWithIncDec --></div>
<!-- /crusterSwitch --> </div>


<div class="crusterSwitch valueTo">
<div class="containerBitWithIncDec">
<div class="componentSwitchHex">
<span class="codeHex">0</span>
<ul class="seriesSwitch">
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a></li>
</ul>
</div>
<!-- /containerBitWithIncDec --></div>
<!-- /crusterSwitch --> </div>

<div class="containerSignCalc"><span class="containerParticle"><a class="contentSignCalc signPlus" href="javascript:void(0);">+</a></span></div>

<div class="crusterSwitch result">
<div class="containerBitWithIncDec">
<div class="componentSwitchHex">
<span class="codeHex">0</span>
<ul class="seriesSwitch">
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a><span class="indicationDigit">16</span></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a><span class="indicationDigit">8</span></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a><span class="indicationDigit">4</span></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a><span class="indicationDigit">2</span></li>
<li class="containerSwitch"><a class="contentSwitch" href="javascript:void(0);"></a><span class="indicationDigit">1</span></li>
</ul>
</div>
<!-- /containerBitWithIncDec --></div>
<!-- /crusterSwitch --> </div>
<!-- /demoEto --> </div>


<!-- /appdemoBinarySwitch --></div>

<script src="js/script.js"></script>

<script>
;(function() {

document.addEventListener('DOMContentLoaded', () => {
  const settings = {
    waitBitTransition: 100,
    classnameTurnedOn: 'on'
  };
  const seriesBitResult = Array.from(document.querySelectorAll('.result'));
  const signPlus = document.querySelector('.signPlus');
  const seriesValue = Array.from(document.querySelectorAll('.codeHex'));

  const seriesBunchOfBit = Array.from(document.querySelectorAll('.componentSwitchHex'));
  const bunchOfBitAdded = Array.from(seriesBunchOfBit[0].querySelectorAll('.contentSwitch'));
  const bunchOfBitAdd = Array.from(seriesBunchOfBit[1].querySelectorAll('.contentSwitch'));
  const bunchOfBitResult = Array.from(seriesBunchOfBit[2].querySelectorAll('.contentSwitch'));

  signPlus.addEventListener('click', (ev) => {
    swellBounce(signPlus);
    fireParticle(signPlus);

    bunchOfBitResult.forEach((bitResult) => {
      bitResult.classList.remove(settings.classnameTurnedOn);
    });

    /*/
    // +++++++++++++++++++++++++++++++ JSの10進数計算を利用
    const valAdded = parseInt('0x' + seriesValue[0].innerText, 16);
    const valAdd = parseInt('0x' + seriesValue[1].innerText, 16);

    const valTotal = valAdded + valAdd;
    const seriesResultBinary = ('00000' + valTotal.toString(2)).slice(-5).split('');

    seriesResultBinary.forEach((resultBinary, ix) => {
      bunchOfBitResult[ix].classList.remove(settings.classnameTurnedOn);

      if(resultBinary === '1') {
        bunchOfBitResult[ix].classList.add(settings.classnameTurnedOn);
      }
      else {
        bunchOfBitResult[ix].classList.remove(settings.classnameTurnedOn);
      }
    })
    /*/

    // +++++++++++++++++++++++++++++++ ビット演算を展開
    // push, popは使わずインデックス参照でやる
    const ixLowerEndCalculated = bunchOfBitAdded.length - 1;
    let seriesIsCarryingUp = []; // [true, true ...]
  
    let ixBitResult, digitAdded, digitAdd, digitCarry, xorAddedAdd;

    for(let ix = ixLowerEndCalculated; ix >= 0; ix --) {
      setTimeout(() => { // setTimeout コマ送り動作
        ixBitResult = ix + 1;

        digitAdded = bunchOfBitAdded[ix].classList.contains(settings.classnameTurnedOn);
        digitAdd = bunchOfBitAdd[ix].classList.contains(settings.classnameTurnedOn);
        digitCarry = bunchOfBitResult[ixBitResult].classList.contains(settings.classnameTurnedOn);

        // 対象二項のXOR判定
        xorAddedAdd = (digitAdded ^ digitAdd) ? true : false;
        // 繰り上げが伝達されている場合は反転
        resultBitCurrent = (xorAddedAdd ^ digitCarry) ? true : false;

        // 当該桁の結果描画
        if(resultBitCurrent) {
          bunchOfBitResult[ixBitResult].classList.add(settings.classnameTurnedOn);
        }
        else {
          bunchOfBitResult[ixBitResult].classList.remove(settings.classnameTurnedOn);
        }

        swellBounce(bunchOfBitResult[ixBitResult]);
        fireParticle(bunchOfBitResult[ixBitResult]);

        // 繰り上げを一位上の桁にストア（一時的に描画）
        if(((digitAdded && !digitAdd) || (!digitAdded && digitAdd)) && digitCarry) {
          bunchOfBitResult[ixBitResult -1].classList.add(settings.classnameTurnedOn);

          // 最上位に繰り上がるときはパーティクルを発生
          if(ixBitResult -1 === 0) {
            setTimeout(() => {
              swellBounce(bunchOfBitResult[ixBitResult - 1]);
              fireParticle(bunchOfBitResult[ixBitResult - 1]);
            }, settings.waitBitTransition);
          }
        }
        if((digitAdded && digitAdd)) {
          bunchOfBitResult[ixBitResult -1].classList.add(settings.classnameTurnedOn);

          if(ixBitResult -1 === 0) {
            setTimeout(() => {
              swellBounce(bunchOfBitResult[ixBitResult - 1]);
              fireParticle(bunchOfBitResult[ixBitResult - 1]);
            }, settings.waitBitTransition);
          }
        }
      }, settings.waitBitTransition * ((bunchOfBitResult.length - 1) - (ix + 1)));
    }
  });
});

})();
</script>

</body>
</html>
